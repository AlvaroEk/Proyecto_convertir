"use strict";var sharp=require("sharp"),potrace=require("potrace"),_require=require("../models/historymodel"),insertarRegistro=_require.insertarRegistro;function convertirImagen(r,n){var t,a,o,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r.file){e.next=3;break}return e.abrupt("return",n.status(400).send("No se ha proporcionado ning√∫n archivo"));case 3:if(t="png",r.body.opciones&&("JPEG"===(a=r.body.opciones.toUpperCase())?t="jpeg":"JPG"===a?t="jpg":"SVG"!==a&&"PNG"!==a&&"WEBP"!==a||(t=a.toLowerCase())),"svg"===t)return e.next=8,regeneratorRuntime.awrap(sharp(r.file.buffer).toBuffer());e.next=14;break;case 8:return o=e.sent,e.next=11,regeneratorRuntime.awrap(new Promise(function(n,t){potrace.trace(o,{threshold:128},function(e,r){e?t(e):n(r)})}));case 11:o=e.sent,e.next=17;break;case 14:return e.next=16,regeneratorRuntime.awrap(sharp(r.file.buffer).toFormat(t).toBuffer());case 16:o=e.sent;case 17:return e.next=19,regeneratorRuntime.awrap(insertarRegistro(r.file.originalname,"imagen_convertida.".concat(t),t));case 19:if(s=r.session.conversionesRealizadas||0,r.isAuthenticated()){e.next=27;break}if(!(s<3)){e.next=26;break}s++,r.session.conversionesRealizadas=s,e.next=27;break;case 26:return e.abrupt("return",n.redirect("/login"));case 27:n.set({"Content-Type":"image/".concat(t),"Content-Disposition":'attachment; filename="imagen_convertida.'.concat(t,'"')}),n.send(o),e.next=35;break;case 31:e.prev=31,e.t0=e.catch(0),console.error("Error al convertir la imagen:",e.t0),n.status(500).send("Error interno del servidor");case 35:case"end":return e.stop()}},null,null,[[0,31]])}module.exports={convertirImagen:convertirImagen};
//# sourceMappingURL=conversionController.min.js.map
